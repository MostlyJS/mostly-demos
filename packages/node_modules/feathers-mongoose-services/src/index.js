const hooks = require('feathers-hooks');
const mostly = require('mostly-node');
const feathers = require('mostly-feathers');
const { connectDb } = require('mostly-feathers-mongoose');
const nats = require('nats');

const { config } = require('common');
const services = require('./services');

const trans = new mostly(nats.connect(config.nats), {
  name: 'feathers-mongoose-services',
  logLevel: 'info'
});

trans.ready(() => {
  const app = feathers(trans)
    .configure(hooks())
    .configure(connectDb(config.mongodb.db))
    .configure(services)
    .start();
});

trans.onError(e => {
  console.error('Error [' + config.nats + ']: ' + e);
  process.exit();
});

// If the Node process ends, close the Nats connection
process.on('SIGINT', () => {
  console.log('Nats connection closed [app termination]');
  trans.close(() => process.exit(0));
});